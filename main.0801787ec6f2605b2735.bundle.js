(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{270:function(module,exports,__webpack_require__){__webpack_require__(271),__webpack_require__(417),module.exports=__webpack_require__(418)},335:function(module,exports){},418:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),function(module){__webpack_require__(33),__webpack_require__(26),__webpack_require__(18),__webpack_require__(34),__webpack_require__(35);var _storybook_react__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(166),req=__webpack_require__(608);Object(_storybook_react__WEBPACK_IMPORTED_MODULE_5__.configure)((function loadStories(){req.keys().forEach((function(filename){return req(filename)}))}),module)}.call(this,__webpack_require__(419)(module))},608:function(module,exports,__webpack_require__){var map={"./index.stories.tsx":609};function webpackContext(req){var id=webpackContextResolve(req);return __webpack_require__(id)}function webpackContextResolve(req){if(!__webpack_require__.o(map,req)){var e=new Error("Cannot find module '"+req+"'");throw e.code="MODULE_NOT_FOUND",e}return map[req]}webpackContext.keys=function webpackContextKeys(){return Object.keys(map)},webpackContext.resolve=webpackContextResolve,module.exports=webpackContext,webpackContext.id=608},609:function(module,exports,__webpack_require__){"use strict";(function(module){var __values=this&&this.__values||function(o){var s="function"==typeof Symbol&&Symbol.iterator,m=s&&o[s],i=0;if(m)return m.call(o);if(o&&"number"==typeof o.length)return{next:function(){return o&&i>=o.length&&(o=void 0),{value:o&&o[i++],done:!o}}};throw new TypeError(s?"Object is not iterable.":"Symbol.iterator is not defined.")},__importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var react_1=__webpack_require__(166),react_2=__importDefault(__webpack_require__(55));__webpack_require__(610),__webpack_require__(612),__webpack_require__(614);var PadComponent_1=__webpack_require__(616),PeerDoc_1=__importDefault(__webpack_require__(619)),HubDoc_1=__importDefault(__webpack_require__(620)),AutomergeCodeMirror_1=__importDefault(__webpack_require__(621));react_1.storiesOf("Collaboration",module).add("Multiple CodeMirrors linked to a single Automerge doc",(function(){var e_1,_a,peerDocById=new Map,hubDoc=new HubDoc_1.default((function(peerId,msg){return setTimeout((function(){return peerDocById.get(peerId).applyMessage(msg)}),0)}),(function(msg){return Array.from(peerDocById.values()).forEach((function(peerDoc){return setTimeout((function(){return peerDoc.applyMessage(msg)}),0)}))})),peerIds=["Wilma","Fred","Barney"],_loop_1=function(peerId){peerDocById.set(peerId,new PeerDoc_1.default((function(msg){return setTimeout((function(){return hubDoc.applyMessage(peerId,msg)}),0)})))};try{for(var peerIds_1=__values(peerIds),peerIds_1_1=peerIds_1.next();!peerIds_1_1.done;peerIds_1_1=peerIds_1.next()){_loop_1(peerIds_1_1.value)}}catch(e_1_1){e_1={error:e_1_1}}finally{try{peerIds_1_1&&!peerIds_1_1.done&&(_a=peerIds_1.return)&&_a.call(peerIds_1)}finally{if(e_1)throw e_1.error}}return react_2.default.createElement("div",null,react_2.default.createElement("p",null,"Below are three actors - Wilma, Fred and Barney. They each have a Pad with sheets. Each sheet is connected to a CodeMirror editor."),react_2.default.createElement("p",null,"The source code is at",react_2.default.createElement("a",{href:"https://github.com/aslakhellesoy/automerge-codemirror/blob/master/stories/index.stories.tsx"},"here"),"."),react_2.default.createElement("div",{className:"pads"},peerIds.map((function(peerId){var timer,peerDoc=peerDocById.get(peerId);return react_2.default.createElement("div",{key:peerId},react_2.default.createElement("h3",null,peerId),react_2.default.createElement(PadComponent_1.PadComponent,{peerDoc:peerDoc,automergeCodeMirror:new AutomergeCodeMirror_1.default((function(changeFn){peerDoc.change(changeFn),clearTimeout(timer),timer=setTimeout((function(){return peerDoc.notify()}),5e3)}))}))}))))}))}).call(this,__webpack_require__(80)(module))},614:function(module,exports,__webpack_require__){var api=__webpack_require__(164),content=__webpack_require__(615);"string"==typeof(content=content.__esModule?content.default:content)&&(content=[[module.i,content,""]]);var options={insert:"head",singleton:!1},exported=(api(content,options),content.locals?content.locals:{});module.exports=exported},615:function(module,exports,__webpack_require__){(exports=__webpack_require__(165)(!1)).push([module.i,".CodeMirror {\n  height: auto;\n  background: inherit;\n}\n\n.pads {\n  display: flex;\n}\n\n.pad {\n  margin: 10px;\n  border: black solid 1px;\n}\n\n.sheet {\n  margin: 4px;\n  border: black solid 1px;\n}\n",""]),module.exports=exports},616:function(module,exports,__webpack_require__){"use strict";var __read=this&&this.__read||function(o,n){var m="function"==typeof Symbol&&o[Symbol.iterator];if(!m)return o;var r,e,i=m.call(o),ar=[];try{for(;(void 0===n||n-- >0)&&!(r=i.next()).done;)ar.push(r.value)}catch(error){e={error:error}}finally{try{r&&!r.done&&(m=i.return)&&m.call(i)}finally{if(e)throw e.error}}return ar},__importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}},__importStar=this&&this.__importStar||function(mod){if(mod&&mod.__esModule)return mod;var result={};if(null!=mod)for(var k in mod)Object.hasOwnProperty.call(mod,k)&&(result[k]=mod[k]);return result.default=mod,result};Object.defineProperty(exports,"__esModule",{value:!0});var automerge_1=__importDefault(__webpack_require__(37)),react_1=__importStar(__webpack_require__(55)),codemirror_1=__importDefault(__webpack_require__(617)),AutomergeCodeMirrorComponent_1=__importDefault(__webpack_require__(618));exports.PadComponent=function(_a){var peerDoc=_a.peerDoc,automergeCodeMirror=_a.automergeCodeMirror,_b=__read(react_1.useState(peerDoc.doc),2),doc=_b[0],setDoc=_b[1];function makeCodeMirror(element){return codemirror_1.default(element,{viewportMargin:1/0,lineWrapping:!0,extraKeys:{Tab:!1}})}return react_1.useEffect((function(){return peerDoc.subscribe((function(oldDoc,newDoc){automergeCodeMirror.updateCodeMirrors(oldDoc,newDoc),setDoc(newDoc)}))}),[]),react_1.default.createElement("div",{className:"pad"},react_1.default.createElement("button",{onClick:function createSheet(){peerDoc.change((function(proxy){null==proxy.sheets&&(proxy.sheets=[]),proxy.sheets.push(new automerge_1.default.Text)})),peerDoc.notify()}},"New Sheet"),react_1.default.createElement("button",{onClick:function removeSheet(){peerDoc.change((function(proxy){proxy.sheets&&proxy.sheets.shift()})),peerDoc.notify()}},"Remove Sheet"),(doc.sheets||[]).map((function(_,i){return react_1.default.createElement("div",{key:i,className:"sheet"},react_1.default.createElement(AutomergeCodeMirrorComponent_1.default,{doc:doc,makeCodeMirror:makeCodeMirror,automergeCodeMirror:automergeCodeMirror,getText:function getText(doc){return doc.sheets[i]}}))})))}},618:function(module,exports,__webpack_require__){"use strict";var __importStar=this&&this.__importStar||function(mod){if(mod&&mod.__esModule)return mod;var result={};if(null!=mod)for(var k in mod)Object.hasOwnProperty.call(mod,k)&&(result[k]=mod[k]);return result.default=mod,result};Object.defineProperty(exports,"__esModule",{value:!0});var react_1=__importStar(__webpack_require__(55));exports.default=function(props){var codeMirrorDiv,doc=props.doc,makeCodeMirror=props.makeCodeMirror,automergeCodeMirror=props.automergeCodeMirror,getText=props.getText;return react_1.useEffect((function(){var codeMirror=makeCodeMirror(codeMirrorDiv);return automergeCodeMirror.connectCodeMirror(doc,codeMirror,getText)}),[]),react_1.default.createElement("div",{ref:function(div){return codeMirrorDiv=div}})}},619:function(module,exports,__webpack_require__){"use strict";var __values=this&&this.__values||function(o){var s="function"==typeof Symbol&&Symbol.iterator,m=s&&o[s],i=0;if(m)return m.call(o);if(o&&"number"==typeof o.length)return{next:function(){return o&&i>=o.length&&(o=void 0),{value:o&&o[i++],done:!o}}};throw new TypeError(s?"Object is not iterable.":"Symbol.iterator is not defined.")},__importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var manymerge_1=__webpack_require__(269),automerge_1=__importDefault(__webpack_require__(37)),PeerDoc=function(){function PeerDoc(sendMsg){this.handlers=new Set,this._doc=automerge_1.default.init(),this.peer=new manymerge_1.Peer(sendMsg)}return Object.defineProperty(PeerDoc.prototype,"doc",{get:function(){return this._doc},enumerable:!0,configurable:!0}),PeerDoc.prototype.applyMessage=function(msg){var e_1,_a,oldDoc=this._doc,newDoc=this.peer.applyMessage(msg,oldDoc);if(newDoc){this._doc=newDoc;try{for(var _b=__values(this.handlers),_c=_b.next();!_c.done;_c=_b.next()){(0,_c.value)(oldDoc,newDoc)}}catch(e_1_1){e_1={error:e_1_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_1)throw e_1.error}}}},PeerDoc.prototype.change=function(changeFn){var e_2,_a,oldDoc=this._doc;this._doc=automerge_1.default.change(this._doc,changeFn);try{for(var _b=__values(this.handlers),_c=_b.next();!_c.done;_c=_b.next()){(0,_c.value)(oldDoc,this._doc)}}catch(e_2_1){e_2={error:e_2_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_2)throw e_2.error}}},PeerDoc.prototype.notify=function(){this.peer.notify(this._doc)},PeerDoc.prototype.subscribe=function(handler){var _this=this;return this.handlers.add(handler),function(){_this.handlers.delete(handler)}},PeerDoc}();exports.default=PeerDoc},620:function(module,exports,__webpack_require__){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var manymerge_1=__webpack_require__(269),automerge_1=__importDefault(__webpack_require__(37)),HubDoc=function(){function HubDoc(sendMsgTo,broadcastMsg){this._doc=automerge_1.default.init(),this.hub=new manymerge_1.Hub(sendMsgTo,broadcastMsg)}return HubDoc.prototype.applyMessage=function(peerId,msg){var newDoc=this.hub.applyMessage(peerId,msg,this._doc);newDoc&&(this._doc=newDoc)},HubDoc}();exports.default=HubDoc},621:function(module,exports,__webpack_require__){"use strict";var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var automerge_1=__importDefault(__webpack_require__(37)),updateCodeMirrorDocs_1=__importDefault(__webpack_require__(622)),Mutex_1=__importDefault(__webpack_require__(623)),updateAutomergeText_1=__importDefault(__webpack_require__(624)),AutomergeCodeMirror=function(){function AutomergeCodeMirror(change){this.change=change,this.mutex=new Mutex_1.default,this.codeMirrorByTextId=new Map}return AutomergeCodeMirror.prototype.getCodeMirror=function(textObjectId){return this.codeMirrorByTextId.get(textObjectId)},AutomergeCodeMirror.prototype.connectCodeMirror=function(doc,codeMirror,getText){var _this=this,text=getText(doc);if(!text)throw new Error("Cannot connect CodeMirror. Did not find text in "+JSON.stringify(doc));var textId=automerge_1.default.getObjectId(text);this.codeMirrorByTextId.set(textId,codeMirror),codeMirror.setValue(text.toString());var codeMirrorChangeHandler=function(editor,editorChange){"automerge"!==editorChange.origin&&(_this.mutex.lock(),_this.change((function(proxy){return updateAutomergeText_1.default(proxy,getText,editor.getDoc(),editorChange)})),_this.mutex.release())};return codeMirror.on("change",codeMirrorChangeHandler),function(){codeMirror.off("change",codeMirrorChangeHandler),_this.codeMirrorByTextId.delete(textId)}},AutomergeCodeMirror.prototype.updateCodeMirrors=function(oldDoc,newDoc){return updateCodeMirrorDocs_1.default(oldDoc,newDoc,this.getCodeMirror.bind(this),this.mutex)},AutomergeCodeMirror}();exports.default=AutomergeCodeMirror},622:function(module,exports,__webpack_require__){"use strict";var __values=this&&this.__values||function(o){var s="function"==typeof Symbol&&Symbol.iterator,m=s&&o[s],i=0;if(m)return m.call(o);if(o&&"number"==typeof o.length)return{next:function(){return o&&i>=o.length&&(o=void 0),{value:o&&o[i++],done:!o}}};throw new TypeError(s?"Object is not iterable.":"Symbol.iterator is not defined.")},__importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var automerge_1=__importDefault(__webpack_require__(37));exports.default=function updateCodeMirrorDocs(oldDoc,newDoc,getCodeMirror,mutex){var e_1,_a;if(mutex.locked||!oldDoc)return newDoc;var diffs=automerge_1.default.diff(oldDoc,newDoc);try{for(var diffs_1=__values(diffs),diffs_1_1=diffs_1.next();!diffs_1_1.done;diffs_1_1=diffs_1.next()){var diff=diffs_1_1.value;if("text"===diff.type){var codeMirror=getCodeMirror(diff.obj);if(codeMirror){var codeMirrorDoc=codeMirror.getDoc();switch(diff.action){case"insert":var fromPos=codeMirrorDoc.posFromIndex(diff.index);codeMirrorDoc.replaceRange(diff.value,fromPos,void 0,"automerge");break;case"remove":fromPos=codeMirrorDoc.posFromIndex(diff.index);var toPos=codeMirrorDoc.posFromIndex(diff.index+1);codeMirrorDoc.replaceRange("",fromPos,toPos,"automerge")}}}}}catch(e_1_1){e_1={error:e_1_1}}finally{try{diffs_1_1&&!diffs_1_1.done&&(_a=diffs_1.return)&&_a.call(diffs_1)}finally{if(e_1)throw e_1.error}}return newDoc}},623:function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Mutex=function(){function Mutex(){}return Object.defineProperty(Mutex.prototype,"locked",{get:function(){return this._locked},enumerable:!0,configurable:!0}),Mutex.prototype.lock=function(){if(this._locked)throw new Error("Already locked");this._locked=!0},Mutex.prototype.release=function(){if(!this._locked)throw new Error("Not locked");this._locked=!1},Mutex}();exports.default=Mutex},624:function(module,exports,__webpack_require__){"use strict";var __read=this&&this.__read||function(o,n){var m="function"==typeof Symbol&&o[Symbol.iterator];if(!m)return o;var r,e,i=m.call(o),ar=[];try{for(;(void 0===n||n-- >0)&&!(r=i.next()).done;)ar.push(r.value)}catch(error){e={error:error}}finally{try{r&&!r.done&&(m=i.return)&&m.call(i)}finally{if(e)throw e.error}}return ar},__spread=this&&this.__spread||function(){for(var ar=[],i=0;i<arguments.length;i++)ar=ar.concat(__read(arguments[i]));return ar};Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=function updateAutomergeText(proxy,getText,codeMirrorDoc,editorChange){var text=getText(proxy);if(text){var startPos=codeMirrorDoc.indexFromPos(editorChange.from),removedLines=editorChange.removed||[],addedLines=editorChange.text,removedLength=removedLines.reduce((function(sum,remove){return sum+remove.length+1}),0)-1;removedLength>0&&text.deleteAt(startPos,removedLength);var addedText=addedLines.join("\n");addedText.length>0&&text.insertAt.apply(text,__spread([startPos],addedText.split("")))}}}},[[270,1,2]]]);
//# sourceMappingURL=main.0801787ec6f2605b2735.bundle.js.map